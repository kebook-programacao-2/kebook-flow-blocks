
import type { EnvPayloadModel, Payload } from "$lib/types";

const ENV_PAYLOAD: EnvPayloadModel = {
   "expert_username": {
      "value": "",
      "schema": {
         "label": "Nome de usuário",
         "tooltip": "Nome do usuário do expert",
         "placeholder": "Selecione um usuário",
         "fields_type": "select",
         "options": [
            {
               "label": "Dev da Silva",
               "value": "Dev da Silva"
            },
            {
               "label": "Vinicio Junio de Oliveira",
               "value": "Vinicio Junio de Oliveira"
            },
            {
               "label": "Fernanda Aparecida Massa Tex",
               "value": "Fernanda Aparecida Massa Tex"
            },
            {
               "label": "NATHALIE LOCKLEY",
               "value": "NATHALIE LOCKLEY"
            },
            {
               "label": "Aline silveira Rosa",
               "value": "Aline silveira Rosa"
            },
            {
               "label": "andressa pinheiro freire",
               "value": "andressa pinheiro freire"
            },
            {
               "label": "CARLOS WILSON DE SOUZA PEREIRA 72930420600",
               "value": "CARLOS WILSON DE SOUZA PEREIRA 72930420600"
            },
            {
               "label": "WLADIMIR HENRIQUE BUOSI",
               "value": "WLADIMIR HENRIQUE BUOSI"
            },
            {
               "label": "poliana dos santos bonze",
               "value": "poliana dos santos bonze"
            },
            // {
            //    "label": "Kebook LTDA",
            //    "value": "Kebook LTDA"
            // },
            {
               "label": "Marcelo Ricardo de Carvalho Ribeiro",
               "value": "42181433000130"
            },
            {
               "label": "LUCIMAR BEATRIZ DOS SANTOS 02075732043",
               "value": "LUCIMAR BEATRIZ DOS SANTOS 02075732043"
            },
            {
               "label": "leandro santo marques",
               "value": "leandro santo marques"
            },
            {
               "label": "Moadir mariano da Silva",
               "value": "Moadir mariano da Silva"
            },
            {
               "label": "Thaís aparecida Marques da Silva",
               "value": "Thaís aparecida Marques da Silva"
            },
            {
               "label": "Gustavo Vinicius Pina Martins",
               "value": "Gustavo Vinicius Pina Martins"
            },
            {
               "label": "Amanda Loren",
               "value": "AMANDA LOREN DE OLIVEIRA COLPAS 30187981809"
            },
            {
               "label": "Marcelo Fenoll Ramal",
               "value": "Marcelo Fenoll Ramal"
            },
            {
               "label": "CLEVERSON MARTINS TEIXEIRA",
               "value": "CLEVERSON MARTINS TEIXEIRA"
            },
            {
               "label": "Thiago Gomes Vegette",
               "value": "Thiago Gomes Vegette"
            },
            {
               "label": "Geane de Lima Santana Carvalho",
               "value": "Geane de Lima Santana Carvalho"
            },
            {
               "label": "wagner luiz do nascimento silva",
               "value": "wagner luiz do nascimento silva"
            },
            {
               "label": "Gorete Aparecida Souza Perin",
               "value": "Gorete Aparecida Souza Perin"
            },
            {
               "label": "Maria Daniely Oliveira da Silva",
               "value": "Maria Daniely Oliveira da Silva"
            },
            {
               "label": "Leopoldo Rojas Gavilan",
               "value": "Leopoldo Rojas Gavilan"
            },
            {
               "label": "neldson alves batista",
               "value": "neldson alves batista"
            },
            {
               "label": "João Vitor Barbosa de Carlos",
               "value": "João Vitor Barbosa de Carlos"
            },
            {
               "label": "canaltopreceitas@gmail.com",
               "value": "canaltopreceitas@gmail.com"
            },
            {
               "label": "melificafsi@gmail.com",
               "value": "melificafsi@gmail.com"
            },
            {
               "label": "Maikelane Lopes da Cruz silva",
               "value": "Maikelane Lopes da Cruz silva"
            },
            {
               "label": "Bernardo de Oliveira Fernandes",
               "value": "Bernardo de Oliveira Fernandes"
            },
            {
               "label": "SABEDORIA DA MULHER EMPREENDIMENTOS ONLINE LTDA",
               "value": "SABEDORIA DA MULHER EMPREENDIMENTOS ONLINE LTDA"
            },
            {
               "label": "LUCAS DE OLIVEIRA SANTOS 12",
               "value": "LUCAS DE OLIVEIRA SANTOS 12"
            },
            {
               "label": "Amanda Lima da Silva",
               "value": "Amanda Lima da Silva"
            },
            {
               "label": "José Roberto  da Conceiçao",
               "value": "José Roberto  da Conceiçao"
            },
            {
               "label": "Sandra Maria Rodrigues",
               "value": "Sandra Maria Rodrigues"
            },
            {
               "label": "Raphael Galvao",
               "value": "R. GALVAO NASCIMENTO LTDA"
            },
            {
               "label": "Mario Hermes de Jesus Sobral",
               "value": "Mario Hermes de Jesus Sobral"
            },
            {
               "label": "HENRIQUE GUIRRA BONFIM",
               "value": "HENRIQUE GUIRRA BONFIM"
            },
            {
               "label": "Renato Goetten",
               "value": "Renato Goetten"
            },
            {
               "label": "Oton Safraide",
               "value": "S O ESTUDIO LTDA"
            },
            {
               "label": "Rodrigo Godoy",
               "value": "35.590.954 RODRIGO REIS DE GODOY"
            },
            {
               "label": "Jaize Barreto da Silveira",
               "value": "Jaize Barreto da Silveira"
            },
            {
               "label": "Danielle Celi Vitor de Barros",
               "value": "Danielle Celi Vitor de Barros"
            },
            {
               "label": "Rute Lacerda Tarelho",
               "value": "Rute Lacerda Tarelho"
            },
            {
               "label": "Ray Siqueira",
               "value": "BETEL BRS LTDA"
            },
            {
               "label": "Luis Fernando de Moraes",
               "value": "Luis Fernando de Moraes"
            },
            {
               "label": "Antonio Mariano Montandon Lauro Jardim",
               "value": "Antonio Mariano Montandon Lauro Jardim"
            },
            {
               "label": "AMANDA LYSSA BATISTA DE JESUS FERNANDES",
               "value": "AMANDA LYSSA BATISTA DE JESUS FERNANDES"
            },
            {
               "label": "José Paulo Sebastiao da Silva",
               "value": "José Paulo Sebastiao da Silva"
            },
            {
               "label": "Fabíola da Silva Pereira",
               "value": "Fabíola da Silva Pereira"
            },
            {
               "label": "Eduardo Lauro Jardim",
               "value": "Eduardo Lauro Jardim"
            },
            {
               "label": "LEIA FERREIRA DA SILVA",
               "value": "LEIA FERREIRA DA SILVA"
            },
            {
               "label": "Jessiane Santos",
               "value": "cursojessy@gmail.com"
            },
            {
               "label": "CLEONICE PEREIRA SANTOS SILVA",
               "value": "CLEONICE PEREIRA SANTOS SILVA"
            },
            {
               "label": "Luiz Fernandes Neves",
               "value": "Luiz Fernandes Neves"
            },
            {
               "label": "Cristiane de Souza Moura",
               "value": "Cristiane de Souza Moura"
            },
            {
               "label": "Bruna Vieira",
               "value": "brunna.paganini@hotmail.com"
            }
         ]
      }
   }
};

const PAYLOAD: Payload = {
   "env": {
      "expert_username": "Dev da Silva",
      "_email": "dev@kebook.com.br",
      "_password": "KZ5Zw=Hy5n+&RnR",
      "_kiwify_device_token": "YGVn23enZ1z0CjwS2NaX84lJZxKURo1qJalkPUuHituRydlSdktAoLVmrU6CWcLabDZ4Gf2c4f4inlFt2tYAX5TMUFmJVuY4Az0j",
      "_pages": {
         "main_page": "main_page",
         "titan": "Titan Page"
      },
      "_titan": {
         "email": "dev@kebook.com.br",
         "password": "3r59Jr&eq9*2zeTx7emu"
      }
   },
   "flows": {
      "main_flow": [
         {
            "command": "run_flow",
            "enabled": true,
            "flow": "login"
         },
         {
            "command": "run_flow",
            "enabled": true,
            "flow": "select_user"
         },
         {
            "command": "run_flow",
            "enabled": false,
            "flow": "get_2fa_code"
         }
      ],
      "login": [
         {
            "command": "goto",
            "enabled": true,
            "target": "https://dashboard.kiwify.com.br/"
         },
         {
            "command": "eval_expression",
            "enabled": true,
            "expression": "localStorage.setItem('kiwi_device_token_8egvUrhQjiRsxuLSXUdWXhPUBJB3', '@@_kiwify_device_token@');"
         },
         {
            "command": "keyboard_type",
            "enabled": true,
            "target": "//*/input[@name='email']",
            "value": "@@_email@"
         },
         {
            "command": "keyboard_type",
            "enabled": true,
            "target": "//*/input[@name='password']",
            "value": "@@_password@"
         },
         {
            "command": "user_click",
            "enabled": true,
            "target": "//*/button[contains(text(), 'Entrar')]"
         },
         {
            "command": "eval_expression",
            "enabled": true,
            "expression": "env({ recaptcha_error: x(\"//*[contains(text(), 'Recaptcha Error')]\")?.innerText || 'None found' })"
         },
         {
            "command": "wait_for_navigation",
            "enabled": true
         }
      ],
      "select_user": [
         {
            "command": "click",
            "enabled": true,
            "target": "//*/div[contains(@class, 'hidden sticky')]//a[contains(@href, '/?team=')]//*[contains(text(), '@@expert_username@')]"
         },
         {
            "command": "wait_for_dom_render",
            "enabled": true,
            "time": ""
         }
      ],
      "get_2fa_code": [
         {
            "command": "new_page",
            "enabled": true,
            "page_id": "@@_pages.titan@"
         },
         {
            "command": "goto",
            "enabled": true,
            "target": "https://titan.hostgator.com.br/mail/"
         },
         {
            "command": "keyboard_type",
            "enabled": true,
            "target": "//*/input[@name=\"email\"]",
            "value": "@@_titan.email@"
         },
         {
            "command": "keyboard_type",
            "enabled": true,
            "target": "//*/input[@name=\"password\"]",
            "value": "@@_titan.password@"
         },
         {
            "command": "click",
            "enabled": true,
            "target": "//*/button[@data-testid=\"login-button\"]"
         },
         {
            "command": "wait_for_navigation",
            "enabled": true
         },
         {
            "command": "eval_expression",
            "enabled": true,
            "expression": "async_eval(12, 5000, (res) => {    const lastEmailTimestampXPath = '(//*/div[contains(@class, \"list-tabular-item unread\")])[1]//span[contains(@class, \"timestamp \")]';    const lastEmailXPath = '(//*/div[contains(@class, \"list-tabular-item unread\")])[1]//div[@class=\"subject\"]/div[contains(text(), \"Código de verificação\")]';         if (x(lastEmailXPath)) {        if (x(lastEmailTimestampXPath).innerText.match(/^[A-z]*/g)[0].length === 0) {           const lastEmailTimestamp_12h = x(lastEmailTimestampXPath).innerText.split(/(\\d*:?\\d*)(\\w*)/gi).filter(v => v).join(' ').toUpperCase();           const lastEmailTimestamp_24h = new Date('01/01/2024 ' + lastEmailTimestamp_12h).toLocaleTimeString('pt-BR', { timeStyle: 'short' });          console.log(lastEmailTimestamp_24h);                     const currentTimestamp = new Date().toLocaleTimeString('pt-BR', { timeStyle: 'short' });           const rawTimeDiff = Math.floor((new Date(`01/01/2024 ${currentTimestamp}`) - new Date(`01/01/2024 ${lastEmailTimestamp_24h}`)) / 60);           console.log(rawTimeDiff);                     if (rawTimeDiff < 15000) {              res({ kiwify_code: x(lastEmailXPath).innerText.match(/\\d/g).join(''), _expose_key: \"eval_kiwify\" })           }        } else {           console.log('E-mail muito antigo.', x(lastEmailTimestampXPath));           return 'E-mail muito antigo.'; }     } else {        console.log('Último e-mail não é da Kiwify ou já foi aberto.', x(lastEmailXPath));        return 'Último e-mail não é da Kiwify ou já foi aberto.';     }  })"
         },
         {
            "command": "branch_eval",
            "enabled": true,
            "expression": "eval_kiwify.kiwify_code && true",
            "success_flow": "code_found",
            "error_flow": "no_code_found"
         }
      ],
      "code_found": [
         {
            "command": "select_page",
            "enabled": true,
            "page_id": "@_pages.main_page@"
         },
         {
            "command": "keyboard_type",
            "enabled": true,
            "target": "//*/input[@type=\"tel\"]",
            "value": "@@$$res:kiwify_code@",
            "trigger_onchange_on_tab": true
         },
         {
            "command": "click",
            "enabled": true,
            "target": "//*/button[contains(text(), 'Verificar')]"
         },
         {
            "command": "wait_for_navigation",
            "enabled": true
         }
      ],
      "no_code_found": [
         {
            "command": "eval_expression",
            "enabled": true,
            "expression": "(() => ({ error: 'No code found :(' }))()"
         }
      ]
   },
   "config": {
      "ws_endpoint": "",
      "close_browser_on_finish": false,
      "close_browser_on_cancel_request": false,
      "headless": true
   }
};

export const KiwifyLoginBlock = {
    title: 'Kiwify - Login',
    block_id: '258e3800-5d46-455f-b20a-2ebb6743cedb',
    description: 'Faz login na Kiwify (com 2FA).',
    tags: ['kiwify'],
    payload: PAYLOAD,
    env_payload: ENV_PAYLOAD
}